name: Upload Plugin Artifact to S3

on:
  workflow_call:
    inputs:
      plugin_name:
        required: true
        type: string
      branch_name:
        required: true
        type: string
      run_number:
        required: true
        type: string

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  upload:
    name: Upload to S3
    runs-on: ubuntu-latest

    env:
      AWS_ROLE_ARN: ${{ vars.AWS_ROLE_ARN || secrets.AWS_ROLE_ARN }}
      S3_PLUGIN_BUCKET: ${{ vars.S3_PLUGIN_BUCKET || secrets.S3_PLUGIN_BUCKET }}
      AWS_REGION: ${{ vars.AWS_REGION || secrets.AWS_REGION }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-libs
          path: build/libs

      - name: Debug path values
        run: |
          echo "S3 bucket: ${{ env.S3_PLUGIN_BUCKET }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Plugin name: ${{ inputs.plugin_name }}"
          echo "Branch: ${{ inputs.branch_name }}"
          echo "Run number: ${{ inputs.run_number }}"

      - name: Upload plugin artifact to S3
        run: |
          DEST="s3://${{ env.S3_PLUGIN_BUCKET }}/${{ inputs.plugin_name }}/${{ inputs.branch_name }}/build-${{ inputs.run_number }}"
          echo "Uploading JARs to: $DEST"
          aws s3 cp "build/libs" "$DEST" --recursive --exclude "*" --include "*.jar" --region "${{ env.AWS_REGION }}"
